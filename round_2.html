<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>2nd Round è¡¨ç¤ºç”»é¢</title>
  <style>
    body {
      background-color: #fdebf0;
      font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
      text-align: center;
      padding: 20px;
    }

    h1 {
      color: #b56fdc;
      font-size: 2em;
      margin-bottom: 10px;
    }

    #question-area {
      margin-bottom: 20px;
    }

    #question-number {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    #question-text {
      font-size: 1em;
      margin-bottom: 5px;
    }

    #answer-text {
      font-size: 0.9em;
      color: red;
    }

    #player-count {
      margin: 10px;
    }

    .players {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background-color: white;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 90px;
      height: 420px;
      border: 4px solid #90ee90;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 10px 5px;
      position: relative;
    }

    .card input {
      width: 90%;
      font-size: 14px;
      border: none;
      border-bottom: 1px solid #ccc;
      background: transparent;
      text-align: center;
      margin: 4px 0;
    }

    .controls, .color-buttons, .confirm-button {
      writing-mode: horizontal-tb;
    }

    .score {
      font-size: 14px;
      margin-top: 10px;
    }

    .color-buttons {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      margin-top: 10px;
    }

    .color-button {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }


    .red { background-color: #ffc9c9; border-color: #ff7f7f; }
    .blue { background-color: #cce0ff; border-color: #6699ff; }
    .yellow { background-color: #fff9c4; border-color: #fdd835; }
    .green { background-color: #c8facc; border-color: #6edc87; }

    .card.show input,
    .card.show .confirm-button {
      display: none;
    }

    .card .display-info {
      display: none;
      font-size: 14px;
      line-height: 1.5;
    }

    .card.show .display-info {
      display: block;
      text-align: center;
      white-space: normal;
    }

    .button-group {
      margin: 10px;
    }
    .disqualification-message {
      position: absolute;
      top: 10px;
      left: -25px;
      transform: rotate(-45deg);
      font-size: 24px;
      font-weight: bold;
      color: white;
      background: #FF1493;
      padding: 5px 40px;
      border-radius: 5px;
      z-index: 5;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      pointer-events: none;
      white-space: nowrap;
      writing-mode: horizontal-tb;
    }

    
  </style>
</head>
<body>
  <h1>2nd Round è¡¨ç¤ºç”»é¢</h1>

  <div id="question-area">
    <div id="question-number">å•é¡Œç•ªå·</div>
    <div id="question-text">å•é¡Œæ–‡ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="answer-text">ç­”ãˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="button-group">
      <button onclick="toggleQuestion()">å•é¡Œæ–‡ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
      <button onclick="toggleAnswer()">ç­”ãˆã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
      <button onclick="prevQuestion()">å‰ã®å•é¡Œã¸</button>
      <button onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
    </div>
  </div>

  <div>
    äººæ•°ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š
    <select id="player-count">
      <option value="1">1äºº</option>
      <option value="2">2äºº</option>
      <option value="3">3äºº</option>
      <option value="4">4äºº</option>
      <option value="5" selected>5äºº</option>
      <option value="6">6äºº</option>
      <option value="7">7äºº</option>
      <option value="8">8äºº</option>
      <option value="9">9äºº</option>
      <option value="10">10äºº</option>
      <option value="11">11äºº</option>
      <option value="12">12äºº</option>
    </select>
    <button onclick="generatePlayers()">æ±ºå®š</button>
  </div>

  <div class="players" id="player-container"></div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQauPJe0jkiS52L65yXobA_KJ2Hc4ri5WrObyHe4j88wEwjcxAKzGzaXmgYahuVmM-ix2imGAA8lNR4/pub?gid=0&single=true&output=csv";

    let showQuestion = true;
    let showAnswer = true;
    let currentRank = 1;

    function toggleQuestion() {
      showQuestion = !showQuestion;
      updateQuestionVisibility();
    }

    function toggleAnswer() {
      showAnswer = !showAnswer;
      updateQuestionVisibility();
    }

    function updateQuestionVisibility() {
      document.getElementById("question-text").style.display = showQuestion ? "block" : "none";
      document.getElementById("answer-text").style.display = showAnswer ? "block" : "none";
    }

    function generatePlayers() {
      const container = document.getElementById("player-container");
      container.innerHTML = "";

      const savedCount = parseInt(localStorage.getItem("playerCount")) || 0;

      if (savedCount > 0) {
    // ğŸ” ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒ
        for (let i = 0; i < savedCount; i++) {
          const data = JSON.parse(localStorage.getItem(`player_${i}`));
          if (!data) continue;

          const card = document.createElement("div");
          card.className = "card show";
          if (data.color) card.classList.add(data.color);

          card.innerHTML = `
            <div class="display-info">
              <strong>${data.name}</strong><br>
              ${data.school}<br>
              ${data.rank}ä½
            </div>
            <div class="controls">
              <button onclick="addScore(this, 'maru')">ã€‡</button>
              <button onclick="addScore(this, 'batsu')">Ã—</button>
              <button onclick="resetScore(this)">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="score">ã€‡<span class="maru">${data.maru || 0}</span> Ã—<span class="batsu">${data.batsu || 0}</span></div>
            <div class="color-buttons">
              <button class="color-button" onclick="changeColor(this, 'red')">èµ¤</button>
              <button class="color-button" onclick="changeColor(this, 'blue')">é’</button>
              <button class="color-button" onclick="changeColor(this, 'yellow')">é»„</button>
              <button class="color-button" onclick="changeColor(this, 'green')">ç·‘</button>
            </div>
      `    ;
          container.appendChild(card);
        }
  } else {
    // ğŸ†• æ–°ã—ãã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    const count = parseInt(document.getElementById("player-count").value);
    localStorage.setItem("playerCount", count); // åˆå›ã®ã¿è¨˜éŒ²

    for (let i = 0; i < count; i++) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <input placeholder="é †ä½" class="rank-input">
        <input placeholder="å­¦æ ¡å" class="school-input">
        <input placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" class="name-input">
        <button class="confirm-button" onclick="confirmPlayer(this)">æ±ºå®š</button>
        <div class="display-info"></div>
        <div class="controls">
          <button onclick="addScore(this, 'maru')">ã€‡</button>
          <button onclick="addScore(this, 'batsu')">Ã—</button>
          <button onclick="resetScore(this)">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div class="score">ã€‡<span class="maru">0</span> Ã—<span class="batsu">0</span></div>
        <div class="color-buttons">
          <button class="color-button" onclick="changeColor(this, 'red')">èµ¤</button>
          <button class="color-button" onclick="changeColor(this, 'blue')">é’</button>
          <button class="color-button" onclick="changeColor(this, 'yellow')">é»„</button>
          <button class="color-button" onclick="changeColor(this, 'green')">ç·‘</button>
        </div>
      `;
      container.appendChild(card);
    }
  }
}

    function confirmPlayer(btn) {
      const card = btn.closest(".card");
      const rank = card.querySelector(".rank-input").value;
      const school = card.querySelector(".school-input").value;
      const name = card.querySelector(".name-input").value;
      const info = card.querySelector(".display-info");
      // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      info.innerHTML = `<div><strong>${name}</strong></div><div>${school}</div><div>${rank}ä½</div>`;
      card.classList.add("show");

      const index = Array.from(document.querySelectorAll(".card")).indexOf(card); // ä½•ç•ªç›®ã®ã‚«ãƒ¼ãƒ‰ã‹å–å¾—

  // ä¿å­˜å¯¾è±¡ãƒ‡ãƒ¼ã‚¿
       const playerData = {
        name: name,
        school: school,
        rank: rank
       };

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆä¾‹ï¼šplayer_0, player_1...ï¼‰
      localStorage.setItem(`player_${index}`, JSON.stringify(playerData));
    }
  

    function ordinal(n) {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function lockCard(card) {
      card.querySelectorAll("button").forEach(btn => btn.disabled = true);
    }

    function addScore(btn, type) {
      const card = btn.closest(".card");
      if (card.classList.contains("finished") || card.classList.contains("failed")) return;

      const maruSpan = card.querySelector(".maru");
      const batsuSpan = card.querySelector(".batsu");
      let maru = parseInt(maruSpan.textContent);
      let batsu = parseInt(batsuSpan.textContent);

      if (type === 'maru') maru++;
      if (type === 'batsu') batsu++;

      maruSpan.textContent = maru;
      batsuSpan.textContent = batsu;

      const info = card.querySelector(".display-info");

      if (maru >= 5) {
        
        
        card.classList.add("finished");

        const rank = currentRank;
        
        const rankTag = document.createElement("div");
        rankTag.innerHTML = `<strong>${ordinal(currentRank)}</strong>`;
        info.appendChild(rankTag);

        
        currentRank++;
        lockCard(card);
        return;
      }

      if (batsu >= 2) {
        card.classList.add("failed");

        if (!card.querySelector(".disqualification-message")) {
          const disqLabel = document.createElement("span");
          disqLabel.className = "disqualification-message";
          disqLabel.textContent = "å¤±æ ¼";
          card.appendChild(disqLabel);
        }
        const failTag = document.createElement("div");
        failTag.innerHTML = `<span style='color:red;font-weight:bold;'>å¤±æ ¼</span>`;
        info.appendChild(failTag);
        lockCard(card);
        return;
      }
    }

    function resetScore(btn) {
      const card = btn.closest(".card");
      card.querySelector(".maru").textContent = "0";
      card.querySelector(".batsu").textContent = "0";
    }

    function changeColor(btn, color) {
      const card = btn.closest(".card");
      card.classList.remove("red", "blue", "yellow", "green");
      card.classList.add(color);
    }
    function prevQuestion() {
      let currentIndex = parseInt(localStorage.getItem("currentQuestionNumber") || "1", 10);
      currentIndex = Math.max(1, currentIndex - 1); // 1æœªæº€ã«ã¯ãªã‚‰ãªã„ã‚ˆã†ã«
      localStorage.setItem("currentQuestionNumber", currentIndex);
      location.reload(); // å‰ã®å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
    }
    function nextQuestion() {
      let currentIndex = parseInt(localStorage.getItem("currentQuestionNumber") || "1",10);
      currentIndex++;
      localStorage.setItem("currentQuestionNumber", currentIndex);
      location.reload(); // æ¬¡ã®å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
    }
    function showDisqualificationOnCard(index) {
      const card = document.getElementById(`player-${index}`);
      if (card && !card.querySelector(".disqualification-message")) {
        const label = document.createElement("span");
        label.className = "disqualification-message";
        label.textContent = "å¤±æ ¼";
        card.appendChild(label);
      }
    }
    function fetchAndDisplayQuestion() {
      fetch(CSV_URL)
        .then(res => res.text())
        .then(text => {
          const rows = text.trim().split("\n").map(r => r.split(","));
          const index = parseInt(localStorage.getItem("currentQuestionNumber")) || 1;
          if (index >= rows.length) return;

          const question = rows[index][2];
          const answer = rows[index][3];

          document.getElementById("question-number").textContent = `ç¬¬${index}å•`;
          document.getElementById("question-text").textContent = question;
          toggleQuestion();
          document.getElementById("answer-text").textContent = answer;
          toggleAnswer();

          updateQuestionVisibility();
        });
    }

    document.addEventListener("input", e => {
      if (e.target.classList.contains("rank-input")) {
        const card = e.target.closest(".card");
        const val = parseInt(e.target.value);
        card.classList.remove("rank-1", "rank-2", "rank-3");
        if ([1, 2, 3].includes(val)) card.classList.add(`rank-${val}`);
      }
    });

    window.onload = () => {
      generatePlayers();
      fetchAndDisplayQuestion();
    
    };
  </script>
</body>
</html>
