<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3 Round Î³è¡¨ç¤ºç”»é¢</title>
  <style>
    body {
      background-color: #fdebf0;
      font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #b56fdc;
      font-size: 2em;
      margin-bottom: 10px;
    }

    #question-area {
      margin-bottom: 20px;
    }

    #question-number {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    #question-text {
      font-size: 1em;
      margin-bottom: 5px;
    }

    #answer-text {
      font-size: 0.9em;
      color: red;
    }

    #player-count {
      margin: 10px;
    }

    .players {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background-color: white;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 90px;
      height: 420px;
      border: 4px solid #90ee90;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 10px 5px;
      position: relative;
    }

    .card input {
      width: 90%;
      font-size: 14px;
      border: none;
      border-bottom: 1px solid #ccc;
      background: transparent;
      text-align: center;
      margin: 4px 0;
    }

    .controls, .color-buttons, .confirm-button {
      writing-mode: horizontal-tb;
    }

    .score {
      font-size: 14px;
      margin-top: 10px;
    }

    .color-buttons{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
  margin-top: 5px;
}

    .color-button {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }


    .red { background-color: #ffc9c9; border-color: #ff7f7f; }
    .blue { background-color: #cce0ff; border-color: #6699ff; }
    .yellow { background-color: #fff9c4; border-color: #fdd835; }
    .green { background-color: #c8facc; border-color: #6edc87; }

    .card.show input,
    .card.show .confirm-button {
      display: none;
    }

    .card .display-info {
      display: none;
      font-size: 14px;
      line-height: 1.5;
    }

    .card.show .display-info {
      display: block;
      text-align: center;
      white-space: normal;
    }

    .button-group {
      margin: 10px;
    }
    .disqualification-message {
      position: absolute;
      top: 150px;
      left: -25px;
      transform: rotate(-45deg);
      font-size: 24px;
      font-weight: bold;
      color: white;
      background: #FF1493;
      padding: 5px 40px;
      border-radius: 5px;
      z-index: 5;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      pointer-events: none;
      white-space: nowrap;
      writing-mode: horizontal-tb;
    }
.rank-label {
      position: absolute;
      top: 150px;
      left: -25px;
      transform: rotate(-45deg);
      font-size: 24px;
      font-weight: bold;
      color: white;
      background: #ffc0cb;
      padding: 5px 40px;
      border-radius: 5px;
      z-index: 5;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      pointer-events: none;
      white-space: nowrap;
      writing-mode: horizontal-tb;
    }
    .rank-1 {
  background-color: #f8a2d3;
  color: white;
}

.rank-2 {
  background-color: #9cecf0;
  color: white;
}

.rank-3 {
  background-color: #fff08a;
  color: #333;
}

.rank-4{
  background-color: #7fffd4
  color : white;
}

.rank-other {
  background-color: #7fffd4;
  color: white;
}
.xyz-points {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 10px;
  font-size: 14px;
  margin-bottom: 8px;
}
.heart-icon {
  font-size: 16px;
  margin-bottom: 2px;
  color: hotpink;
  display: none;
}
.heart-active {
  display: block !important;
}
  </style>

</head>
<body>
  <h1>3Round Î³ã‚³ãƒ¼ã‚¹</h1>

  <div id="question-area">
    <div id="question-number">å•é¡Œç•ªå·</div>
    <div id="question-text">å•é¡Œæ–‡ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="answer-text">ç­”ãˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="button-group">
      <button onclick="toggleQuestion()">å•é¡Œæ–‡ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
      <button onclick="toggleAnswer()">ç­”ãˆã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
      <button onclick="prevQuestion()">å‰ã®å•é¡Œã¸</button>
      <button onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
    </div>
  </div>

  <div>
    äººæ•°ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š
    <select id="player-count">
      <option value="1">1äºº</option>
      <option value="2">2äºº</option>
      <option value="3">3äºº</option>
      <option value="4">4äºº</option>
      <option value="5" selected>5äºº</option>
      <option value="6">6äºº</option>
      <option value="7">7äºº</option>
      <option value="8">8äºº</option>
      <option value="9">9äºº</option>
      <option value="10">10äºº</option>
      <option value="11">11äºº</option>
      <option value="12">12äºº</option>
    </select>
     <button onclick="onPlayerCountConfirmed()">æ±ºå®š</button>
  </div>
  <label for="question-selector">å•é¡Œç•ªå·ã‚’é¸æŠï¼š</label>
<select id="question-selector">
  <!-- JSã§å•é¡Œæ•°ã«å¿œã˜ã¦è‡ªå‹•è¿½åŠ  -->
</select>


  <div class="players" id="player-container"></div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/17OwcH6j0ktoxka6dMJxeUZfw4DXkeEU_Nnih5fYq85s/export?format=csv";

    let showQuestion = true;
    let showAnswer = true;
    let currentRank = 1;
    
    function toggleQuestion() {
      showQuestion = !showQuestion;
      updateQuestionVisibility();
    }

    function toggleAnswer() {
      showAnswer = !showAnswer;
      updateQuestionVisibility();
    }

    function updateQuestionVisibility() {
      document.getElementById("question-text").style.display = showQuestion ? "block" : "none";
      document.getElementById("answer-text").style.display = showAnswer ? "block" : "none";
    }
    
    function initializeQuestionSelector(totalQuestions) {
  const selector = document.getElementById("question-selector");
  selector.innerHTML = ""; // æ—¢å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰Šé™¤

  for (let i = 1; i <= totalQuestions; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `ç¬¬${i}å•`;
    selector.appendChild(option);
  }

  // ç¾åœ¨ã®å•é¡Œã«ã‚ã‚ã›ã¦é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
  const current = parseInt(localStorage.getItem("currentQuestionNumber") || "1", 10);
  selector.value = current;
}
  document.getElementById("question-selector").addEventListener("change", function () {
  const selected = parseInt(this.value, 10);
  localStorage.setItem("currentQuestionNumber", selected);
  location.reload(); // ã¾ãŸã¯ fetchAndDisplayQuestion() ã‚’ç›´æ¥å‘¼ã‚“ã§ã‚‚OK
});
    
 function generatePlayers(count) {
  const container = document.getElementById("player-container");
  container.innerHTML = "";
 let savedCount = 0;

    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®æ•°ã‚’æ•°ãˆã‚‹
  while (localStorage.getItem(`player_${savedCount}`)) {
    savedCount++;
  }

  // æŒ‡å®šãŒãªã„å ´åˆã¯ä¿å­˜ã•ã‚ŒãŸäººæ•°ã‚’ä½¿ã†
  if (typeof count === "undefined" || count === null) {
    count = savedCount;
  } else {
    // äººæ•°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ â†’ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
    for (let i = 0; i < savedCount; i++) {
      localStorage.removeItem(`player_${i}`);
    }
  }

  for (let i = 0; i < count; i++) {
    const card = document.createElement("div");
    card.className = "card";
    card.id = `player-${i}`;

    // localStorageã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const data = JSON.parse(localStorage.getItem(`player_${i}`)) || {
      name: "",
      school: "",
      roundrank: 0,
      rank: "",
      color: "",
      score: 0,
      xPoint:0,
      yPoint:6,
      zPoint:1,
      isContinue: false,
      finished: false,
      failed: false
    };
   currentRank = Math.max(currentRank, data.roundrank + 1);

    card.innerHTML = `
      <div class="info">
        <input placeholder="é †ä½" class="rank-input" value="${data.rank || ""}">
        <input placeholder="å­¦æ ¡å" class="school-input" value="${data.school || ""}">
        <input placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" class="name-input" value="${data.name || ""}">
        <button class="confirm-button" onclick="confirmPlayerData(${i})">æ±ºå®š</button>
      </div>
       <div class="display-info"></div>
      <div class="score">
       <div class="heart-icon">ğŸ’–</div>
      <div class="xyz-points">
        <div><span class="maru">${data.xPoint}</span></div>
        <div><span class="penalty-points">${data.yPoint}</span></div>
        <div><span class="bonusscore">${data.zPoint}</span></div>
        </div>
        <button onclick="addUpdownScore(this.closest('.card'), 'correct')">â—‹æ­£è§£</button>
        <button onclick="addUpdownScore(this.closest('.card'), 'wrong')">Ã—ä¸æ­£è§£</button>
        <button onclick="resetScore(this)">ãƒªã‚»ãƒƒãƒˆ</button> 
      </div>
      <div class="color-buttons">
        <button class="color-button" onclick="changeColor(this, 'red')">èµ¤</button>
        <button class="color-button" onclick="changeColor(this, 'blue')">é’</button>
        <button class="color-button" onclick="changeColor(this, 'yellow')">é»„</button>
        <button class="color-button" onclick="changeColor(this, 'green')">ç·‘</button>
      </div>
    `;
    card.classList.remove("red", "blue", "yellow", "green");
    if ( data.color !== "") {
  card.classList.add(data.color);
}
  if (data.isContinue) {
  card.querySelector(".heart-icon").classList.add("heart-active");
}
    // ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚„å¤±æ ¼è¡¨ç¤º
    const info = card.querySelector(".display-info");

    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§ä¿å­˜
    card.querySelector(".name-input").addEventListener("input", () => savePlayerData(i));
    card.querySelector(".school-input").addEventListener("input", () => savePlayerData(i));
    card.querySelector(".rank-input").addEventListener("input", () => savePlayerData(i));

    container.appendChild(card);
      // âœ… å‹ã¡æŠœã‘å‡¦ç†ï¼ˆ48ç‚¹ï¼‰
  if (data.xPoint * data.yPoint * data.zPoint >= 48) {
    data.finished = true;
    card.classList.add("finished");

    const rankText = ordinal(data.roundrank); // ä¾‹: 1st
    const rankClass = ["rank-1", "rank-2", "rank-3", "rank-4"][data.roundrank - 1] || "rank-other";

    const label = document.createElement("div");
    label.className = `rank-label ${rankClass}`;
    label.textContent = `${rankText}`;

    card.classList.add("show");
    
    card.querySelector(".display-info").appendChild(label);

    lockCard(card);
  }

  // å¤±æ ¼å‡¦ç†
  if (data.yPoint <= 0) {
    data.failed = true;
    card.classList.add("failed");
    lockCard(card);
    if (!card.querySelector(".disqualification-message")) {
      const disq = document.createElement("div");
      disq.className = "disqualification-message";
      disq.textContent = "å¤±æ ¼";
      card.appendChild(disq);
    }
  }
    localStorage.setItem(`player_${i}`, JSON.stringify(data));
  }
}

    function confirmPlayer(btn) {
      const card = btn.closest(".card");
      const rank = card.querySelector(".rank-input").value;
      const school = card.querySelector(".school-input").value;
      const name = card.querySelector(".name-input").value;
      const info = card.querySelector(".display-info");
      // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      info.innerHTML = `<div><strong>${name}</strong></div><div>${school}</div><div>${rank}ä½</div>`;
      card.classList.add("show");

      const index = Array.from(document.querySelectorAll(".card")).indexOf(card); // ä½•ç•ªç›®ã®ã‚«ãƒ¼ãƒ‰ã‹å–å¾—

  // ä¿å­˜å¯¾è±¡ãƒ‡ãƒ¼ã‚¿
       const playerData = {
        name: name,
        school: school,
        rank: rank
       };

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆä¾‹ï¼šplayer_0, player_1...ï¼‰
      localStorage.setItem(`player_${index}`, JSON.stringify(playerData));
    }
    function confirmPlayerData(index) {
  const card = document.getElementById(`player-${index}`);
  const name = card.querySelector(".name-input").value;
  const school = card.querySelector(".school-input").value;
 const info = card.querySelector(".display-info");
  const rank = card.querySelector(".rank-input").value;
 info.innerHTML = `<div><strong>${name}</strong></div><div>${school}</div><div>${rank}ä½</div>`;
      card.classList.add("show");
// localStorageã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const data = JSON.parse(localStorage.getItem(`player_${index}`)) || {
      name: "",
      school: "",
      rank: "",
      color: "",
      score: 0,
      bonusscore:0,
      allowedWrong: 2,
      finished: false,
      failed: false
    };
  data.name = name;
  data.school = school;
  data.rank = rank;
  localStorage.setItem(`player_${index}`, JSON.stringify(data));
}
   function savePlayerData(index) {
  const card = document.getElementById(`player-${index}`);
  const name = card.querySelector(".name-input").value;
  const school = card.querySelector(".school-input").value;
 const info = card.querySelector(".display-info");
  const rank = card.querySelector(".rank-input").value;

// localStorageã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const data = JSON.parse(localStorage.getItem(`player_${index}`)) || {
      name: "",
      school: "",
      rank: "",
      color: "",
      score: 0,
      bonusscore:0,
      allowedWrong: 2,
      finished: false,
      failed: false
    };
  data.name = name;
  data.school = school;
  data.rank = rank;
  localStorage.setItem(`player_${index}`, JSON.stringify(data));
}
    function onPlayerCountConfirmed() {
  const count = parseInt(document.getElementById("player-count").value);
  generatePlayers(count); // â† äººæ•°æŒ‡å®šã—ã¦æ–°ã—ãç”Ÿæˆ
}
   function addUpdownScore(card, type) {
  const index = Array.from(document.querySelectorAll(".card")).indexOf(card);
  const data = JSON.parse(localStorage.getItem(`player_${index}`)) || {
    xPoint: 0,
ã€€ã€€yPoint: 6,
ã€€ã€€zPoint: 1,
    isContinue: false,
    finished: false,
    failed: false
  };

  if (data.finished || data.failed) return;

  if (type === "correct") {
    // é€£ç­”åˆ¤å®š
    if (data.isContinue) {
      data.zPoint += 0.5;
    }
    data.xPoint += 1;
    data.isContinue = true;
    document.querySelectorAll(".card").forEach((card, i) => {
    const heart = card.querySelector(".heart-icon");
    if (i === index) {
      heart?.classList.add("heart-active");
    } else {
      heart?.classList.remove("heart-active");
    }
  });
 // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€£ç­”æ¨©ã‚’åˆ‡ã‚‹
    document.querySelectorAll(".card").forEach((otherCard, j) => {
    if (j !== index) {
      const otherData = JSON.parse(localStorage.getItem(`player_${j}`)) || {};
      otherData.isContinue = false;
      localStorage.setItem(`player_${j}`, JSON.stringify(otherData));
    }
  });
  }

  if (type === "wrong") {
     data.yPoint -= 1;
     data.isContinue = false;
    // ãƒãƒ¼ãƒˆéè¡¨ç¤º
  card.querySelector(".heart-icon")?.classList.remove("heart-active");
}

 // å‹ã¡æŠœã‘åˆ¤å®šï¼šx * y * z > 48
  const product = data.xPoint * data.yPoint * data.zPoint;
  if (product >= 48 && !data.finished) {
    data.finished = true;
    card.classList.add("finished");
    const rankText = ordinal(currentRank);
    const rankClass = ["rank-1", "rank-2", "rank-3", "rank-4"][currentRank - 1] || "rank-other";
    data.roundrank = currentRank;

    const label = document.createElement("div");
    label.className = `rank-label ${rankClass}`;
    label.textContent = `${rankText}`;

    card.classList.add("show");
    card.querySelector(".display-info").appendChild(label);
    lockCard(card);
    currentRank++;
  }

  // å¤±æ ¼åˆ¤å®š
  if (data.yPoint <= 0 && !data.failed) {
    data.failed = true;
    card.classList.add("failed");
    lockCard(card);
    if (!card.querySelector(".disqualification-message")) {
      const disq = document.createElement("div");
      disq.className = "disqualification-message";
      disq.textContent = "å¤±æ ¼";
      card.appendChild(disq);
    }
  }
  // è¡¨ç¤ºæ›´æ–°
  card.querySelector(".maru").textContent = `x:${data.xPoint}`;
  card.querySelector(".penalty-points").textContent = `y:${data.yPoint}`;
  card.querySelector(".bonusscore").textContent = `z:${data.zPoint.toFixed(1)}`;
  localStorage.setItem(`player_${index}`, JSON.stringify(data));
}
    function ordinal(n) {
  if (n === 1) return "1st";
  if (n === 2) return "2nd";
  if (n === 3) return "3rd";
  return `${n}th`;
}
  function lockCard(card) {
  card.querySelectorAll("button").forEach(btn => {
    if (!btn.textContent.includes("ãƒªã‚»ãƒƒãƒˆ")) {
      btn.disabled = true;
    }
  });
}

    function resetScore(btn) {
  const card = btn.closest(".card");
  card.querySelector(".maru").textContent = "0";
  card.querySelector(".penalty-points").textContent = "6";
  card.querySelector(".bonusscore").textContent = "1";

  card.classList.remove("finished", "failed", "rank-1", "rank-2", "rank-3", "rank-other");
  card.querySelectorAll("button").forEach(btn => btn.disabled = false);
  card.querySelector(".disqualification-message")?.remove();
  card.querySelector(".rank-label")?.remove();

  const index = Array.from(document.querySelectorAll(".card")).indexOf(card);
  const data = JSON.parse(localStorage.getItem(`player_${index}`)) || {};
  data.xPoint = 0;
  data.yPoint = 6;
  data.zPoint = 1;
  data.isContinue = false;
  data.finished = false;
  data.failed = false;
  localStorage.setItem(`player_${index}`, JSON.stringify(data));
}

    function changeColor(btn, color) {
  const card = btn.closest(".card");
  card.classList.remove("red", "blue", "yellow", "green");
  card.classList.add(color);

  // â˜… è‰²ã‚’ä¿å­˜
  const index = Array.from(document.querySelectorAll(".card")).indexOf(card);
  // localStorageã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const data = JSON.parse(localStorage.getItem(`player_${index}`)) || {
      name: "",
      school: "",
      rank: "",
      color: "",
      score: 0,
      bonusscore:0,
      allowedWrong: 2,
      finished: false,
      failed: false
    };

  data.color = color;
  localStorage.setItem(`player_${index}`, JSON.stringify(data));
}
    function prevQuestion() {
      let currentIndex = parseInt(localStorage.getItem("currentQuestionNumber") || "1", 10);
      currentIndex = Math.max(1, currentIndex - 1); // 1æœªæº€ã«ã¯ãªã‚‰ãªã„ã‚ˆã†ã«
      localStorage.setItem("currentQuestionNumber", currentIndex);
      location.reload(); // å‰ã®å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
    }
    function nextQuestion() {
      let currentIndex = parseInt(localStorage.getItem("currentQuestionNumber") || "1",10);
      currentIndex++;
      localStorage.setItem("currentQuestionNumber", currentIndex);
      location.reload(); // æ¬¡ã®å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
    }
    function showDisqualificationOnCard(index) {
      const card = document.getElementById(`player-${index}`);
      if (card && !card.querySelector(".disqualification-message")) {
        const label = document.createElement("span");
        label.className = "disqualification-message";
        label.textContent = "å¤±æ ¼";
        card.appendChild(label);
      }
    }
    function fetchAndDisplayQuestion() {
      fetch(CSV_URL)
        .then(res => res.text())
        .then(text => {
          
          const rows = text.trim().split("\n").map(r => r.split(","));
          initializeQuestionSelector(rows.length - 1); // è¦‹å‡ºã—ãŒã‚ã‚Œã° -1
          const index = parseInt(localStorage.getItem("currentQuestionNumber")) || 1;
          if (index >= rows.length) return;

          const question = rows[index][2];
          const answer = rows[index][3];

          document.getElementById("question-number").textContent = `ç¬¬${index}å•`;
          document.getElementById("question-text").textContent = question;
          toggleQuestion();
          document.getElementById("answer-text").textContent = answer;
          toggleAnswer();

          updateQuestionVisibility();
        });
    

    }


    window.onload = () => {
      generatePlayers();
      fetchAndDisplayQuestion();
    
    };
  </script>
</body>
</html>
